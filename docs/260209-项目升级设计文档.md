# Bitget 量化交易系统 — 项目升级设计文档

> 版本：v2.0 草案
> 日期：2026-02-09
> 角色：产品经理视角

---

## 一、现状评估

### 1.1 已实现能力

| 模块 | 状态 | 说明 |
|------|------|------|
| Bitget API 客户端 | 完成 | HMAC-SHA256 签名、实盘/模拟盘切换 |
| 现货账户 & 行情 | 完成 | 资产查询、Ticker、K线；下单/撤单基础接口 |
| 合约账户 & 行情 | 完成 | 权益查询、盘口深度、Ticker |
| 合约下单 | 完成 | 限价单、撤单、批量撤单、挂单查询、订单详情 |
| 剥头皮策略引擎 | 完成 | 状态机 + 双循环、post_only 挂单追踪 |
| 风控系统 | 完成 | 最大回撤、日亏限制、仓位限制、冷却期 |
| 挂单合并引擎 | 完成 | 加权均价合并、阈值触发 |
| 前端仪表盘 | 完成 | 策略控制、指标卡片、订单表、事件日志、配置编辑 |
| Docker 部署 | 完成 | nginx + API + Frontend + PostgreSQL |
| 数据库迁移 | 完成 | 4 张表（configs、events、orders、daily_pnl） |

### 1.2 已知缺陷 & 待完善项

| 编号 | 问题 | 严重度 | 说明 |
|------|------|--------|------|
| D-01 | 未实现未实现盈亏（unrealizedPnl） | 高 | 前端始终显示 0，无法反映真实盈亏 |
| D-02 | 无交易对规格动态获取 | 高 | sizePrecision / pricePrecision / 最小下单量全靠手工配置，不同币对需手动调整 |
| D-03 | REST 轮询替代 WebSocket | 中 | 500ms 轮询盘口，延迟高、API 配额消耗大 |
| D-04 | 订单/PnL 不落库 | 中 | 数据库表已建但策略运行时仅内存追踪，重启丢失 |
| D-05 | 无测试覆盖 | 中 | Jest 已配置但 0 测试 |
| D-06 | 单策略单实例 | 低 | Singleton，不支持多交易对并行 |
| D-07 | 前端无状态持久化 | 低 | 刷新页面状态丢失 |

---

## 二、Bitget 交易规则摘要（设计依据）

### 2.1 合约交易（USDT-M 永续）

| 维度 | 规则 |
|------|------|
| **合约类型** | USDT 保证金正向永续合约（线性合约） |
| **保证金模式** | 全仓（crossed）/ 逐仓（isolated） |
| **杠杆** | 1x ~ 125x（主流币对），阶梯保证金制度：仓位越大可用杠杆越低 |
| **最小下单量** | 因交易对而异（BTC 约 0.001 BTC），需通过 `/api/v2/mix/market/contracts` 获取 `minTradeNum` |
| **精度** | `pricePlace`（价格小数位）、`volumePlace`（数量小数位）由交易所定义 |
| **手续费** | Maker 0.02%、Taker 0.06%（VIP 等级可降） |
| **资金费率** | 每 8 小时结算（UTC 00:00/08:00/16:00），正费率多头付空头 |
| **强平** | 保证金率低于维持保证金率时触发；逐仓仅强平该仓位，全仓影响全账户 |
| **限价** | 委托价不能偏离标记价格过大（交易所有保护限价机制） |
| **订单类型** | 限价、市价、计划委托（触发单）、止盈止损、追踪止损 |
| **持仓模式** | 单向持仓 / 双向持仓（买卖方向独立） |

### 2.2 现货交易（含杠杆）

| 维度 | 规则 |
|------|------|
| **订单类型** | 限价单、市价单、计划委托、止盈止损 |
| **手续费** | Maker/Taker 均 0.1%；持 BGB 折扣至 0.08% |
| **杠杆交易** | 逐仓/全仓杠杆，一般 3x ~ 10x |
| **精度** | 价格精度 `priceScale`、数量精度 `quantityScale` 由交易所定义 |
| **最小下单** | `minTradeAmount`（最小数量）、`minTradeUSDT`（最小金额），通过 `/api/v2/spot/public/symbols` 获取 |
| **限价保护** | 限价单不能偏离市价过大（通常 ±50%） |
| **借贷（杠杆）** | 自动借入、手动还款；触发强平时自动平仓还款 |

### 2.3 关键 API 端点（系统需对接）

```
# 合约规格查询（获取精度/最小下单/杠杆档位）
GET /api/v2/mix/market/contracts?productType=USDT-FUTURES&symbol=BTCUSDT

# 现货规格查询
GET /api/v2/spot/public/symbols?symbol=BTCUSDT

# 合约持仓查询
GET /api/v2/mix/position/all-position?productType=USDT-FUTURES&marginCoin=USDT

# 资金费率
GET /api/v2/mix/market/current-fund-rate?symbol=BTCUSDT&productType=USDT-FUTURES

# 标记价格
GET /api/v2/mix/market/mark-price?symbol=BTCUSDT&productType=USDT-FUTURES
```

---

## 三、升级目标

### 核心原则
1. **资金安全第一** — 所有涉及资金的变更必须有防护和验证
2. **交易所规则对齐** — 精度、最小下单量、限价等从交易所动态获取，不再硬编码
3. **数据不丢失** — 订单、PnL 必须持久化
4. **可观测** — 真实盈亏、持仓状态实时可见

### 目标用户场景

```
场景 A：用户在模拟盘启动 BTC 剥头皮策略，观察运行效果
场景 B：用户切换到实盘，设置合理的单笔金额和杠杆
场景 C：用户想跑 ETH 或 SOL，不需要手动查精度和最小下单量
场景 D：用户重启服务器后，历史订单和 PnL 不丢失
场景 E：用户想看到实时的未实现盈亏和资金费率成本
```

---

## 四、功能设计

### 4.1 P0 — 交易对规格自动获取

**问题**：当前 `sizePrecision`、`pricePrecision`、最小下单量全靠手工配置。用户换交易对必须知道正确参数，否则下单失败或产生零数量。

**方案**：

```
启动策略时：
  1. 调用 GET /api/v2/mix/market/contracts 获取合约规格
  2. 自动填充 pricePrecision = pricePlace
  3. 自动填充 sizePrecision = volumePlace
  4. 获取 minTradeNum 作为最小下单量校验基准
  5. 获取 maxLeverage 校验用户杠杆配置
  6. 缓存规格信息，避免重复请求
```

**涉及模块**：
- 新增 `ContractSpecService`（合约规格服务）
- 修改 `StrategyConfigManager.validate()` — 用真实规格校验
- 修改 `ScalpingStrategyEngine.start()` — 启动时自动获取并覆盖精度配置
- 修改 `calculateSize()` — 使用 minTradeNum 作为下限

**数据结构**：
```typescript
interface ContractSpec {
  symbol: string;
  baseCoin: string;
  quoteCoin: string;
  minTradeNum: string;      // 最小下单数量
  pricePlace: number;        // 价格小数位
  volumePlace: number;       // 数量小数位
  sizeMultiplier: string;    // 数量步长
  maxLeverage: number;       // 最大杠杆
  makerFeeRate: string;      // maker 费率
  takerFeeRate: string;      // taker 费率
  minTradeUSDT: string;      // 最小下单金额
  supportMarginCoins: string[];
}
```

### 4.2 P0 — 未实现盈亏 & 持仓查询

**问题**：`unrealizedPnl` 始终返回 `'0'`，用户无法知道当前浮盈浮亏。

**方案**：

```
Loop B 每轮末尾：
  1. 调用 GET /api/v2/mix/position/all-position 获取持仓
  2. 提取 unrealizedPL 字段
  3. 更新策略状态的 unrealizedPnl
  4. 同步到风控模块（含未实现亏损在风控计算中）
```

**涉及模块**：
- 新增 `FuturesAccountService.getPositions()` 方法
- 修改 `ScalpingStrategyEngine.runLoopB()` — 增加持仓查询
- 修改 `RiskController` — 将 unrealizedPnl 纳入回撤计算

### 4.3 P0 — 订单 & PnL 持久化

**问题**：策略运行数据仅在内存中，服务重启全部丢失。数据库表已建但未使用。

**方案**：

```
写入时机：
  - 订单创建时 → INSERT strategy_orders
  - 订单状态变更时 → UPDATE strategy_orders (status, filled_at)
  - 卖单成交时 → INSERT/UPDATE strategy_daily_pnl
  - 策略事件时 → INSERT strategy_events（已有但未启用）

恢复时机：
  - 策略启动时 → 从 strategy_orders 加载 status='pending' 的订单到内存
  - 仪表盘加载时 → 从 strategy_daily_pnl 加载历史 PnL
```

**涉及模块**：
- 新增 `StrategyPersistenceService`（持久化服务）
- 修改 `OrderStateTracker` — 增删改操作同步调用持久化
- 修改 `ScalpingStrategyEngine.start()` — 启动时恢复状态

### 4.4 P1 — 资金费率感知

**问题**：每 8 小时的资金费率结算是持仓成本的重要组成部分，当前系统完全忽略。

**方案**：

```
定时任务（每小时查询一次）：
  1. GET /api/v2/mix/market/current-fund-rate 获取当前资金费率
  2. 展示在前端仪表盘
  3. 若费率异常高（如 > 0.1%），可选触发风控告警

费率结算记录：
  - 在 UTC 00:00/08:00/16:00 前后查询账户变动
  - 将资金费率成本计入 PnL 统计
```

**涉及模块**：
- 新增 `FundingRateService`
- 前端新增费率指标卡片
- `RiskController` 可选纳入费率成本

### 4.5 P1 — WebSocket 实时数据

**问题**：当前盘口追踪使用 500ms REST 轮询，延迟高且消耗 API 配额。

**方案**：

```
WebSocket 频道：
  - 盘口深度（ticker）→ 替代 Loop A 的 getBestBid
  - 订单推送（orders）→ 替代 Loop B 的挂单查询 + 订单详情确认
  - 持仓推送（positions）→ 实时更新 unrealizedPnl

降级策略：
  - WebSocket 断线时自动回退到 REST 轮询
  - 心跳 + 自动重连机制
```

**涉及模块**：
- 新增 `WebSocketService`（连接管理、订阅、重连）
- 修改 `ScalpingStrategyEngine` — 支持 WS/REST 双模式
- 修改前端 — 从 SWR 轮询迁移到 WebSocket 推送（可选）

### 4.6 P1 — 前端升级

**新增页面/组件**：

| 组件 | 功能 |
|------|------|
| 持仓面板 | 展示当前合约持仓、未实现盈亏、杠杆、保证金率 |
| 资金费率卡片 | 当前费率 + 下次结算倒计时 |
| PnL 历史图表 | 日 PnL 曲线（从 strategy_daily_pnl 读取） |
| 交易对选择器 | 下拉选择交易对，自动加载规格参数 |
| 策略启动配置表单 | 启动前填写参数，含规格提示和校验 |

### 4.7 P2 — 多交易对支持

**问题**：当前是 Singleton 单策略实例，只能跑一个交易对。

**方案**：

```
策略管理器（StrategyManager）：
  - 维护 Map<symbol, ScalpingStrategyEngine>
  - 每个交易对独立的引擎实例
  - 共享风控（全局日亏限制）+ 独立风控（单品种回撤）
  - API 端点增加 symbol 参数

限制：
  - 最大同时运行策略数 = 5（防止 API 配额耗尽）
  - 全局仓位限制
```

### 4.8 P2 — 测试体系

| 层级 | 范围 | 工具 |
|------|------|------|
| 单元测试 | calculateSize、风控检查、合并逻辑 | Jest + ts-jest |
| 集成测试 | 策略引擎完整循环（mock API） | Jest + nock |
| 回测 | 历史 K 线数据回放 | 自建回测框架 |

---

## 五、优先级路线图

```
Phase 1（核心修复）
├── P0: 交易对规格自动获取
├── P0: 未实现盈亏 & 持仓查询
└── P0: 订单 & PnL 持久化

Phase 2（体验提升）
├── P1: 资金费率感知
├── P1: WebSocket 实时数据
└── P1: 前端升级（持仓面板、图表、配置表单）

Phase 3（扩展能力）
├── P2: 多交易对支持
├── P2: 测试体系
└── P2: 策略回测框架
```

---

## 六、技术方案要点

### 6.1 交易对规格服务架构

```
                     ┌─────────────────────────┐
                     │  ContractSpecService     │
                     │  (缓存 + 定时刷新)       │
                     └────────┬────────────────┘
                              │
         ┌────────────────────┼──────────────────────┐
         ▼                    ▼                      ▼
  StrategyConfigManager  calculateSize()    前端配置表单
  (启动时校验)           (最小量 / 步长)    (精度提示)
```

### 6.2 数据流（升级后）

```
Bitget Exchange
  │
  ├── WebSocket ──→ 盘口 / 订单推送 ──→ 策略引擎
  │                                      │
  ├── REST API ←── 下单 / 撤单 ←────────┘
  │                                      │
  └── REST API ──→ 持仓 / 费率 ──→ 风控模块
                                         │
                                         ▼
                                   PostgreSQL
                                   ├── strategy_orders
                                   ├── strategy_daily_pnl
                                   ├── strategy_events
                                   └── contract_specs (新)
                                         │
                                         ▼
                                   前端仪表盘
                                   ├── 持仓 & 浮盈
                                   ├── PnL 历史图表
                                   ├── 资金费率
                                   └── 交易对选择器
```

### 6.3 风控升级

当前风控仅基于已实现盈亏，升级后应纳入：

| 因素 | 当前 | 目标 |
|------|------|------|
| 已实现 PnL | 已纳入 | 保持 |
| 未实现 PnL | 未纳入（硬编码 0） | 从持仓接口获取 |
| 资金费率成本 | 未纳入 | 结算时记入日 PnL |
| 保证金率 | 未监控 | 低于阈值时告警/停策略 |
| 全局仓位 | 单策略限制 | 多策略全局限制 |

### 6.4 数据库变更

```sql
-- 新增：交易对规格缓存表
CREATE TABLE contract_specs (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(32) NOT NULL,
  product_type VARCHAR(32) NOT NULL,
  base_coin VARCHAR(16),
  quote_coin VARCHAR(16),
  min_trade_num VARCHAR(32),
  price_place INTEGER,
  volume_place INTEGER,
  size_multiplier VARCHAR(32),
  max_leverage INTEGER,
  maker_fee_rate VARCHAR(16),
  taker_fee_rate VARCHAR(16),
  raw_data JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(symbol, product_type)
);

-- 新增：资金费率记录表
CREATE TABLE funding_rate_history (
  id BIGSERIAL PRIMARY KEY,
  symbol VARCHAR(32) NOT NULL,
  funding_rate VARCHAR(32),
  funding_time TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_funding_symbol_time ON funding_rate_history(symbol, funding_time);
```

---

## 七、风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 交易所 API 变更 | 服务不可用 | 错误监控 + 版本号检查 |
| WebSocket 不稳定 | 数据延迟 | REST 降级回退 |
| 数据库写入延迟 | 内存与 DB 不一致 | 异步写入 + 启动时对账 |
| 多策略资源竞争 | API 限频 | 全局速率限制器 |
| 模拟盘/实盘规则差异 | 模拟通过但实盘失败 | 规格查询统一走真实 API |

---

## 八、成功指标

| 指标 | 当前 | 目标 |
|------|------|------|
| 换交易对配置耗时 | 手动查文档 ~10 分钟 | 自动获取 0 秒 |
| 未实现盈亏准确度 | 0（不可用） | 实时同步，误差 < 1s |
| 服务重启数据恢复 | 全部丢失 | 100% 持久化 |
| 盘口延迟 | 500ms（REST） | < 100ms（WebSocket） |
| 零数量下单错误 | 频繁（手工配精度） | 0（自动规格校验） |

---

## 附录 A：当前 API 端点清单

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | /api/health | 健康检查 |
| GET | /api/account/assets | 现货资产 |
| GET | /api/account/balance/:coin | 单币余额 |
| GET | /api/account/all-balances | 全账户余额 |
| POST | /api/orders/place | 现货下单 |
| POST | /api/orders/cancel | 现货撤单 |
| GET | /api/orders/:orderId | 订单详情 |
| GET | /api/market/tickers | 行情 |
| GET | /api/market/candles | K 线 |
| POST | /api/strategy/start | 启动策略 |
| POST | /api/strategy/stop | 停止策略 |
| GET | /api/strategy/status | 策略状态 |
| PUT | /api/strategy/config | 更新配置 |
| GET | /api/strategy/orders | 订单列表 |
| GET | /api/strategy/events | 事件日志 |
| POST | /api/strategy/emergency-stop | 紧急停止 |
| GET | /api/strategy/pnl | 盈亏汇总 |

## 附录 B：升级后新增 API 端点（规划）

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | /api/contracts/specs/:symbol | 查询交易对规格 |
| GET | /api/contracts/specs | 所有已缓存规格 |
| GET | /api/futures/positions | 当前持仓 |
| GET | /api/futures/funding-rate/:symbol | 当前资金费率 |
| GET | /api/strategy/pnl/history | 历史日 PnL |
| GET | /api/strategy/pnl/chart | 图表数据 |
